name: Build Windows Installer

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v3

    # Û±. Ù¾Ø§ÛŒØªÙˆÙ† Ø§Ùˆ Ø¯ Ø±ÛŒÚ©ÙˆÛŒØ³Ù¼ Ú©ØªØ§Ø¨ØªÙˆÙ† Ø§Ù†Ø³Ù¼Ø§Ù„ÙˆÙ„
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install Request Lib
      run: pip install requests

    # Û². Ø®Ø¨Ø±ØªÛŒØ§: Ù¾Ø±ÙˆØ³Ù‡ Ù¾ÛŒÙ„ Ø´ÙˆÙ‡
    - name: Notify Start
      shell: python
      env:
        TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        CHAT_ID: ${{ secrets.TELEGRAM_TO }}
      run: |
        import requests, os
        msg = "ğŸš€ Ø¹Ø§Ù„ÛŒØ¬Ù†Ø§Ø¨Ù‡! Ø¯ Ø¨ÛŒÙˆÙ„Ú‰ (Build) Ù¾Ø±ÙˆØ³Ù‡ Ù¾ÛŒÙ„ Ø´ÙˆÙ‡. Ù„Ú– Ø§Ù†ØªØ¸Ø§Ø± ÙˆÚ©Ú“Ø¦..."
        try:
            requests.post(f"https://api.telegram.org/bot{os.environ['TOKEN']}/sendMessage", data={'chat_id': os.environ['CHAT_ID'], 'text': msg})
        except: pass

    - name: Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install -r requirements.txt

    # Û³. [Ù†ÙˆÛŒ Ú«Ø§Ù…] Ø®Ø¨Ø±ØªÛŒØ§: Ú©ØªØ§Ø¨ØªÙˆÙ†ÙˆÙ†Ù‡ Ø§Ù†Ø³Ù¼Ø§Ù„ Ø´ÙˆÙ„
    - name: Notify Deps Installed
      shell: python
      env:
        TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        CHAT_ID: ${{ secrets.TELEGRAM_TO }}
      run: |
        import requests, os
        msg = "ğŸ›  Ú©ØªØ§Ø¨ØªÙˆÙ†ÙˆÙ†Ù‡ Ø§Ù†Ø³Ù¼Ø§Ù„ Ø´ÙˆÙ„! Ø§ÙˆØ³ Ø¯ EXE Ø¬ÙˆÚ“ÙˆÙ„Ùˆ Ø¯Ø±ÙˆÙ†Ø¯ Ú©Ø§Ø± Ù¾ÛŒÙ„ÛŒÚ–ÙŠ..."
        try:
            requests.post(f"https://api.telegram.org/bot{os.environ['TOKEN']}/sendMessage", data={'chat_id': os.environ['CHAT_ID'], 'text': msg})
        except: pass

    - name: Build EXE with PyInstaller
      run: pyinstaller --noconsole --onefile --collect-all customtkinter --name "XsraperPs" XsraperPs.py

    # Û´. Ø®Ø¨Ø±ØªÛŒØ§: EXE Ø¬ÙˆÚ“ Ø´Ùˆ
    - name: Notify EXE Built
      if: success()
      shell: python
      env:
        TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        CHAT_ID: ${{ secrets.TELEGRAM_TO }}
      run: |
        import requests, os
        msg = "âœ… Ù„ÙˆÙ…Ú“ÛŒ Ù¾Ú“Ø§Ùˆ: EXE ÙØ§ÛŒÙ„ Ù¾Ù‡ Ø¨Ø±ÛŒØ§Ù„ÛŒØªÙˆØ¨ Ø¬ÙˆÚ“ Ø´Ùˆ. Ø§ÙˆØ³ Ø³ÛŒÙ¼ Ø§Ù¾ (Setup) Ø¬ÙˆÚ“ÛŒÚ–ÙŠ..."
        try:
            requests.post(f"https://api.telegram.org/bot{os.environ['TOKEN']}/sendMessage", data={'chat_id': os.environ['CHAT_ID'], 'text': msg})
        except: pass

    - name: Install Inno Setup Compiler
      run: choco install innosetup

    - name: Compile Setup Wizard
      run: iscc setup.iss

    # Ûµ. Ø®Ø¨Ø±ØªÛŒØ§: Ø³ÛŒÙ¼ Ø§Ù¾ Ø¬ÙˆÚ“ Ø´Ùˆ
    - name: Notify Setup Complete
      if: success()
      shell: python
      env:
        TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        CHAT_ID: ${{ secrets.TELEGRAM_TO }}
      run: |
        import requests, os
        msg = "ğŸ“¦ Ø¯ÙˆÙ‡Ù… Ù¾Ú“Ø§Ùˆ: Ø³ÛŒÙ¼ Ø§Ù¾ Ø¬ÙˆÚ“ Ø´Ùˆ! Ø§ÙˆØ³ Ú«ÛŒÙ¼ Ù‡Ø¨ ØªÙ‡ Ù¾ÙˆØ±ØªÙ‡ Ú©ÛŒÚ–ÙŠ..."
        try:
            requests.post(f"https://api.telegram.org/bot{os.environ['TOKEN']}/sendMessage", data={'chat_id': os.environ['CHAT_ID'], 'text': msg})
        except: pass

    - name: Upload Setup File to GitHub
      uses: actions/upload-artifact@v4
      with:
        name: ElyasScraper_Setup
        path: Output/ElyasScraper_Setup.exe

    # ---------------------------------------------------
    # Û¶. ÙˆØ±ÙˆØ³ØªÛŒ Ú«Ø§Ù…: ÙØ§ÛŒÙ„ Ù„ÛŒÚ–Ù„ (Ø§ÙˆØ³ Ø¯ Python Ù¾Ù‡ ÙˆØ§Ø³Ø·Ù‡)
    # ---------------------------------------------------
    - name: Send Setup via Python
      if: success()
      shell: python
      env:
        TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        CHAT_ID: ${{ secrets.TELEGRAM_TO }}
      run: |
        import requests
        import os

        # Ø¯ ÙØ§ÛŒÙ„ Ø§Ø¯Ø±Ø³ Ø§Ùˆ Ø¯ Ø¨ÙˆÙ¼ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
        file_path = 'Output/ElyasScraper_Setup.exe'
        caption = "ğŸ‰ Ù…Ø¨Ø§Ø±Ú© Ø´Ù‡ Ø§Ø³ØªØ§Ø°Ù‡! Ø¯Ø§ Ø³ØªØ§Ø³Ùˆ ÙˆØ±ÙˆØ³ØªÛŒ ÙØ§ÛŒÙ„ Ø¯ÛŒ."
        token = os.environ['TOKEN']
        chat_id = os.environ['CHAT_ID']

        try:
            with open(file_path, 'rb') as f:
                url = f"https://api.telegram.org/bot{token}/sendDocument"
                data = {'chat_id': chat_id, 'caption': caption}
                files = {'document': f}
                # Ø¯Ù„ØªÙ‡ ÙØ§ÛŒÙ„ Ù„ÛŒÚ–Ù„ Ú©ÛŒÚ–ÙŠ
                resp = requests.post(url, data=data, files=files)
                print("Upload response:", resp.text)
        except Exception as e:
            print(f"Error sending file: {e}")

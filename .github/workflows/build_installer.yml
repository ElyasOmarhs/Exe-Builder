name: Build Windows Installer

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v3

    # Û±. Ù„ÙˆÙ…Ú“ÛŒ Ù¾Ø§ÛŒØªÙˆÙ† Ø§Ù†Ø³Ù¼Ø§Ù„ÙˆØ¦ ØªØ±Ú…Ùˆ Ù…ÙˆÚ– ÙˆÚ©ÙˆÙ„ÛŒ Ø´Ùˆ Ù¾Ù‡ Ù¾ÚšØªÙˆ Ù…ÛŒØ³Ø¬ ÙˆÙ„ÛŒÚ–Ùˆ
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    # Û². Ø®Ø¨Ø±ØªÛŒØ§: Ù¾Ø±ÙˆØ³Ù‡ Ù¾ÛŒÙ„ Ø´ÙˆÙ‡ (Ø¯ Ù¾Ø§ÛŒØªÙˆÙ† Ù¾Ù‡ ÙˆØ§Ø³Ø·Ù‡)
    - name: Notify Start
      shell: python
      env:
        TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        CHAT_ID: ${{ secrets.TELEGRAM_TO }}
      run: |
        import urllib.request, urllib.parse, os
        # Ø¯Ù„ØªÙ‡ Ø®Ù¾Ù„Ù‡ Ù¾ÚšØªÙˆ Ù„ÛŒÚ©Ù†Ù‡ ÙˆÙ„ÛŒÚ©Ø¦ØŒ Ù¾Ø§ÛŒØªÙˆÙ† ÛŒÛ Ù¾Ù‡ Ø®Ù¾Ù„Ù‡ Ø³Ù…ÙˆÙŠ
        msg = "ğŸš€ Ø¹Ø§Ù„ÛŒØ¬Ù†Ø§Ø¨Ù‡! Ø¯ Ø¨ÛŒÙˆÙ„Ú‰ (Build) Ù¾Ø±ÙˆØ³Ù‡ Ù¾ÛŒÙ„ Ø´ÙˆÙ‡. Ù„Ú– Ø§Ù†ØªØ¸Ø§Ø± ÙˆÚ©Ú“Ø¦..."
        url = f"https://api.telegram.org/bot{os.environ['TOKEN']}/sendMessage?chat_id={os.environ['CHAT_ID']}&text={urllib.parse.quote(msg)}"
        try:
            urllib.request.urlopen(url)
        except:
            print("Telegram Message Failed")

    - name: Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install -r requirements.txt

    - name: Build EXE with PyInstaller
      run: pyinstaller --noconsole --onefile --collect-all customtkinter --name "XsraperPs" XsraperPs.py

    # Û³. Ø®Ø¨Ø±ØªÛŒØ§: EXE Ø¬ÙˆÚ“ Ø´Ùˆ
    - name: Notify EXE Built
      if: success()
      shell: python
      env:
        TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        CHAT_ID: ${{ secrets.TELEGRAM_TO }}
      run: |
        import urllib.request, urllib.parse, os
        msg = "âœ… Ù„ÙˆÙ…Ú“ÛŒ Ù¾Ú“Ø§Ùˆ: EXE ÙØ§ÛŒÙ„ Ù¾Ù‡ Ø¨Ø±ÛŒØ§Ù„ÛŒØªÙˆØ¨ Ø¬ÙˆÚ“ Ø´Ùˆ. Ø§ÙˆØ³ Ø³ÛŒÙ¼ Ø§Ù¾ (Setup) Ø¬ÙˆÚ“ÛŒÚ–ÙŠ..."
        url = f"https://api.telegram.org/bot{os.environ['TOKEN']}/sendMessage?chat_id={os.environ['CHAT_ID']}&text={urllib.parse.quote(msg)}"
        try:
            urllib.request.urlopen(url)
        except:
            print("Message Failed")

    - name: Install Inno Setup Compiler
      run: choco install innosetup

    - name: Compile Setup Wizard
      run: iscc setup.iss

    # Û´. Ø®Ø¨Ø±ØªÛŒØ§: Ø³ÛŒÙ¼ Ø§Ù¾ Ø¬ÙˆÚ“ Ø´Ùˆ
    - name: Notify Setup Complete
      if: success()
      shell: python
      env:
        TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        CHAT_ID: ${{ secrets.TELEGRAM_TO }}
      run: |
        import urllib.request, urllib.parse, os
        msg = "ğŸ“¦ Ø¯ÙˆÙ‡Ù… Ù¾Ú“Ø§Ùˆ: Ø³ÛŒÙ¼ Ø§Ù¾ Ø¬ÙˆÚ“ Ø´Ùˆ! Ø§ÙˆØ³ Ú«ÛŒÙ¼ Ù‡Ø¨ ØªÙ‡ Ù¾ÙˆØ±ØªÙ‡ Ú©ÛŒÚ–ÙŠ..."
        url = f"https://api.telegram.org/bot{os.environ['TOKEN']}/sendMessage?chat_id={os.environ['CHAT_ID']}&text={urllib.parse.quote(msg)}"
        try:
            urllib.request.urlopen(url)
        except:
            print("Message Failed")

    - name: Upload Setup File to GitHub
      uses: actions/upload-artifact@v4
      with:
        name: ElyasScraper_Setup
        path: Output/ElyasScraper_Setup.exe

    # Ûµ. ÙˆØ±ÙˆØ³ØªÛŒ Ú«Ø§Ù…: ÙØ§ÛŒÙ„ Ù„ÛŒÚ–Ù„
    # Ø¯ ÙØ§ÛŒÙ„ Ù„ÛŒÚ–Ù„Ùˆ Ù„Ù¾Ø§Ø±Ù‡ curl ØºÙˆØ±Ù‡ Ø¯ÛŒ. Ø¯Ù„ØªÙ‡ Ù…Ø§ caption Ú©ÙˆÚ‰ Ú©Ú“ÛŒ Ø¯ÛŒ Ú†Û Ù¾ÚšØªÙˆ ÛŒÛ Ø®Ø±Ø§Ø¨Ù‡ Ù†Ø´ÙŠ.
    # %20 Ù…Ø¹Ù†ÛŒ ÙØ§ØµÙ„Ù‡ØŒ Ù†ÙˆØ± Ú©ÙˆØ¯ÙˆÙ†Ù‡ Ø¯ Ù¾ÚšØªÙˆ ØªÙˆØ±Ùˆ Ø¯ÙŠ.
    - name: Send Setup to Telegram
      if: success()
      shell: bash
      run: |
        curl -v -F "chat_id=${{ secrets.TELEGRAM_TO }}" \
        -F document=@Output/ElyasScraper_Setup.exe \
        -F "caption=%F0%9F%8E%89%20%D9%85%D8%A8%D8%A7%D8%B1%DA%A9%20%D8%B4%D9%87%20%D8%A7%D8%B3%D8%AA%D8%A7%D8%B0%D9%87%21%20%D8%AF%D8%A7%20%D8%B3%D8%AA%D8%A7%D8%B3%D9%88%20%D9%88%D8%B1%D9%88%D8%B3%D8%AA%DB%8C%20%D9%81%D8%A7%DB%8C%D9%84%20%D8%AF%DB%8C." \
        https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendDocument

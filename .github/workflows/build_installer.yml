name: Build Windows Installer

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests pyinstaller
        pip install -r requirements.txt

    # Û±. Ù¾ÛŒÙ„
    - name: Notify Start
      shell: python
      env:
        TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        CHAT_ID: ${{ secrets.TELEGRAM_TO }}
      run: |
        import requests, os
        try:
            requests.post(f"https://api.telegram.org/bot{os.environ['TOKEN']}/sendMessage", data={'chat_id': os.environ['CHAT_ID'], 'text': "ğŸš€ Ø¹Ø§Ù„ÛŒØ¬Ù†Ø§Ø¨Ù‡! Ø¯ Ø¨ÛŒÙˆÙ„Ú‰ Ù¾Ø±ÙˆØ³Ù‡ Ù¾ÛŒÙ„ Ø´ÙˆÙ‡..."})
        except: pass

    - name: Build EXE
      run: pyinstaller --noconsole --onefile --collect-all customtkinter --name "XsraperPs" XsraperPs.py

    # Û². EXE Ø¬ÙˆÚ“ Ø´Ùˆ
    - name: Notify EXE Ready
      if: success()
      shell: python
      env:
        TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        CHAT_ID: ${{ secrets.TELEGRAM_TO }}
      run: |
        import requests, os
        try:
            requests.post(f"https://api.telegram.org/bot{os.environ['TOKEN']}/sendMessage", data={'chat_id': os.environ['CHAT_ID'], 'text': "âœ… EXE Ø¬ÙˆÚ“ Ø´Ùˆ! Ø§ÙˆØ³ Ø¯ Ø³ÛŒÙ¼ Ø§Ù¾ Ù†ÙˆØ¨Øª Ø¯ÛŒ..."})
        except: pass

    - name: Setup Compiler
      run: choco install innosetup

    - name: Compile Setup
      run: iscc setup.iss

    # Û³. Ø³ÛŒÙ¼ Ø§Ù¾ Ø§Ùˆ ÙØ§ÛŒÙ„ Ù„ÛŒÚ–Ù„ (ÛŒÙˆ ÚØ§ÛŒ)
    # Ù…Ø§ Ø¯Ù„ØªÙ‡ "Ø®Ø¨Ø±ØªÛŒØ§" Ø§Ùˆ "ÙØ§ÛŒÙ„ Ù„ÛŒÚ–Ù„" ÛŒÙˆ ÚØ§ÛŒ Ú©Ú“Ù„ ØªØ±Ú…Ùˆ Ø¯ÙˆÙ‡ ÚÙ„Ù‡ Ù…ÛŒØ³Ø¬ Ø±Ø§Ù†Ø´ÙŠ
    - name: Send Final File
      if: success()
      shell: python
      env:
        TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        CHAT_ID: ${{ secrets.TELEGRAM_TO }}
      run: |
        import requests, os
        
        # Ù„ÙˆÙ…Ú“ÛŒ Ø®Ø¨Ø± ÙˆØ±Ú©ÙˆÙ„
        try:
            requests.post(f"https://api.telegram.org/bot{os.environ['TOKEN']}/sendMessage", data={'chat_id': os.environ['CHAT_ID'], 'text': "ğŸ“¦ Ø³ÛŒÙ¼ Ø§Ù¾ Ø¬ÙˆÚ“ Ø´Ùˆ! Ø§ÙˆØ³ ÙØ§ÛŒÙ„ Ø¯Ø±Ù„ÛŒÚ–Ù„ Ú©ÛŒÚ–ÙŠ..."})
        except: pass

        # Ø¯ÙˆÙ‡Ù…: ÙØ§ÛŒÙ„ Ù„ÛŒÚ–Ù„
        file_path = 'Output/ElyasScraper_Setup.exe'
        caption = "ğŸ‰ Ù…Ø¨Ø§Ø±Ú© Ø´Ù‡ Ø§Ø³ØªØ§Ø°Ù‡! Ø¯Ø§ Ø³ØªØ§Ø³Ùˆ ÙˆØ±ÙˆØ³ØªÛŒ ÙØ§ÛŒÙ„ Ø¯ÛŒ."
        
        try:
            with open(file_path, 'rb') as f:
                url = f"https://api.telegram.org/bot{os.environ['TOKEN']}/sendDocument"
                data = {'chat_id': os.environ['CHAT_ID'], 'caption': caption}
                files = {'document': f}
                requests.post(url, data=data, files=files)
        except Exception as e:
            print(f"Error: {e}")
